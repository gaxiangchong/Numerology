{% extends "base.html" %}
{% block title %}{{ t('app_title') }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- â— Show Upgrade Banner if not PRO -->
  {% if not session.get('is_pro', False) %}
  <div class="bg-surface p-5 rounded-xl shadow text-yellow-400 mb-6">
    <div class="flex items-center justify-between">
      <span>{{ t('upgrade_banner')|safe }}</span>
      <form method="POST" action="/upgrade_to_pro" class="inline">
        <button type="submit" class="ml-4 bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
          {{ t('btn_test_upgrade') }}
        </button>
      </form>
    </div>
  </div>
  {% endif %}
  

  <h1 class="text-3xl font-bold text-textlight mb-6 text-center">{{ t('main_title') }}</h1>

  <!-- ğŸ“ Input Form -->
  <form method="POST" class="bg-surface p-6 rounded-xl shadow-lg space-y-4 mb-10">
    <label for="input_data" class="block text-lg text-textlight font-semibold">{{ t('input_label') }}</label>
    <input type="text" id="input_data" name="input_data" required
           class="w-full px-4 py-2 rounded-md bg-dark border border-soft text-textlight focus:ring-2 focus:ring-highlight outline-none" 
           placeholder="{{ t('input_placeholder') }}" />
    <button type="submit"
            class="w-full bg-highlight hover:bg-blue-700 text-white font-semibold py-2 rounded-md transition-all">
      {{ t('btn_analyze') }}
    </button>
  </form>

  <!-- ğŸ“š Recent Numbers Section -->
  {% if session.get('user') %}
  <div class="bg-surface p-4 rounded-xl shadow mb-6">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-highlight">ğŸ“š {{ t('recent_numbers') }}</h3>
      {% if recent_numbers %}
      <form method="POST" action="/clear_history" class="inline">
        <button type="submit" class="text-sm text-soft hover:text-highlight transition" onclick="return confirm('{{ t('confirm_clear_history') }}')">
          {{ t('btn_clear_history') }}
        </button>
      </form>
      {% endif %}
    </div>
    
    {% if recent_numbers %}
    <div class="flex flex-wrap gap-2">
      {% for number in recent_numbers %}
      <button onclick="fillInput('{{ number }}')" 
              class="px-3 py-1 bg-dark border border-soft rounded-full text-sm hover:bg-highlight hover:text-white transition">
        {{ number }}
      </button>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-soft text-sm">{{ t('no_history') }}</p>
    {% endif %}
  </div>
  {% endif %}

  {% if input_data %}
  <div class="space-y-6">

    <!-- ğŸ“‹ ç”¨æˆ·è¾“å…¥ -->
    <div class="bg-surface p-5 rounded-xl shadow">
      <h2 class="text-xl font-bold text-highlight mb-2">ğŸ§¾ {{ t('your_input') }}</h2>
      <p class="text-textlight text-lg">{{ input_data }}</p>
    </div>

    <!-- ğŸ” ä¸»åˆ†æ -->
    <div class="bg-surface p-5 rounded-xl shadow">
      <h2 class="text-xl font-bold text-highlight mb-2">ğŸ” {{ t('energy_analysis') }}</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border border-gray-700 rounded overflow-hidden">
          <thead class="bg-gray-800 text-textlight">
            <tr>
              <th class="px-4 py-2 border-b border-gray-600">{{ t('combination_type') }}</th>
              <th class="px-4 py-2 border-b border-gray-600">{{ t('number_combination') }}</th>
              <th class="px-4 py-2 border-b border-gray-600">{{ t('total_energy') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for key, value in grouped_stats.items() %}
            <tr class="bg-surface hover:bg-gray-700">
              <td class="px-4 py-2 border-b border-gray-700">{{ key }}</td>
              <td class="px-4 py-2 border-b border-gray-700">{{ group_to_pairs[key] | join(', ') }}</td>
              <td class="px-4 py-2 border-b border-gray-700">
                {% set energy_value = grouped_energy[key] if grouped_energy[key] else 0 %}
                {% set amplification_count = 0 %}
                {% for row in detailed_group_rows %}
                  {% if row.group == key %}
                    {% set amplification_count = amplification_count + row.amplification %}
                  {% endif %}
                {% endfor %}
                {{ energy_value }}%
                {% if amplification_count > 0 %}
                  <span class="text-yellow-400">æ˜¾</span>{% for i in range(amplification_count - 1) %}<span class="text-yellow-400">æ˜¾</span>{% endfor %}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ğŸ“ˆ åˆ†å¸ƒå›¾ -->
    <div class="bg-surface p-5 rounded-xl shadow">
      <h2 class="text-xl font-bold text-highlight mb-2">ğŸ“ˆ {{ t('distribution_chart') }}</h2>
      <canvas id="groupedBarChart" height="120"></canvas>
    </div>

    <script>
      const groupedStats = JSON.parse('{{ grouped_stats_json | tojson | safe }}');

      const labels = Object.keys(groupedStats);
      const data = Object.values(groupedStats).map(item => item.count);

      const colorMap = {
        'å¤©åŒ»': '#22c55e',
        'å»¶å¹´': '#0ea5e9',
        'ç”Ÿæ°”': '#fbbf24',
        'ä¼ä½': '#64748b',
        'ç»å‘½': '#ef4444',
        'ç¥¸å®³': '#f97316',
        'äº”é¬¼': '#a21caf',
        'å…­ç…': '#6366f1'
      };

      const backgroundColors = labels.map(lab => colorMap[lab] || '#a3a3a3');

      const ctx = document.getElementById('groupedBarChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'å‡ºç°æ¬¡æ•°',
            data: data,
            backgroundColor: backgroundColors,
            borderRadius: 8
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: '#334155' }},
            x: { ticks: { color: '#fff' }, grid: { display: false }}
          }
        }
      });
    </script>

    {% if ending_warning %}
    <div class="bg-surface p-5 rounded-xl shadow border border-red-500">
      <h2 class="text-xl font-bold text-red-400 mb-2">ğŸ’¸ ç ´è´¢è­¦ç¤º</h2>
      <p class="text-textlight text-base">{{ ending_warning }}</p>
    </div>
    {% endif %}

    <!-- ğŸ“š å¤§å¸ˆåˆ†æï¼ˆä»…PROç”¨æˆ·ï¼‰ -->
    {% if is_pro %}
      {% if secondary_result %}
      <div class="bg-surface p-5 rounded-xl shadow">
        <h2 class="text-xl font-bold text-green-400 mb-2">ğŸ“˜ è¾…åŠ©ç»„åˆæç¤ºï¼š</h2>
        <ul class="list-disc pl-5 space-y-1">
          {% for result in secondary_result %}
            <li>{{ result }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if special_definitions %}
      <div class="bg-surface p-5 rounded-xl shadow">
        <h2 class="text-xl font-bold text-red-400 mb-2">ğŸš¨ ç‰¹æ®Šç»„åˆæé†’ï¼š</h2>
        <ul class="list-disc pl-5 space-y-1">
          {% for result in special_definitions %}
            <li>{{ result }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- ğŸ“– è¯¦ç»†ç£åœºåˆ†æ -->
      {% if sorted_profiles and is_pro %}
      <div class="bg-surface p-5 rounded-xl shadow">
        <h2 class="text-xl font-bold text-purple-400 mb-4">ğŸ“– è¯¦ç»†ç£åœºåˆ†æ</h2>
        <div class="space-y-6">
          {% for group, description, percent in sorted_profiles %}
          <div class="border border-gray-600 rounded-lg p-4">
            <h3 class="text-lg font-bold text-highlight mb-3">{{ description.title }} ({{ percent }}%)</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-3">
                <div>
                  <h4 class="font-semibold text-green-400 mb-1">âœ… ä¼˜ç‚¹ï¼š</h4>
                  <p class="text-textlight text-sm">{{ description.ä¼˜ç‚¹ }}</p>
                </div>
                <div>
                  <h4 class="font-semibold text-blue-400 mb-1">ğŸ’¼ äº‹ä¸šï¼š</h4>
                  <p class="text-textlight text-sm">{{ description.äº‹ä¸š }}</p>
                </div>
              </div>
              
              <div class="space-y-3">
                <div>
                  <h4 class="font-semibold text-red-400 mb-1">âŒ ç¼ºç‚¹ï¼š</h4>
                  <p class="text-textlight text-sm">{{ description.ç¼ºç‚¹ }}</p>
                </div>
                <div>
                  <h4 class="font-semibold text-yellow-400 mb-1">ğŸ¥ å¥åº·ï¼š</h4>
                  <p class="text-textlight text-sm">{{ description.å¥åº· }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    {% endif %}

  </div>
  {% endif %}

<script>
function fillInput(number) {
  document.getElementById('input_data').value = number;
  // Optional: Auto-submit the form
  // document.querySelector('form').submit();
}
</script>

{% endblock %}
