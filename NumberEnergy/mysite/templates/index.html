<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å‘½ç†åˆ†æå·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#111827',
            surface: '#1F2937',
            highlight: '#3B82F6',
            textlight: '#E5E7EB',
            soft: '#4B5563',
          },
          fontFamily: {
            sans: ['Noto Sans SC', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>

<body class="bg-dark text-textlight font-sans min-h-screen py-10 px-4">

<div class="max-w-2xl mx-auto">

  <!-- ğŸŒ Navigation Bar -->
  <header class="w-full max-w-6xl mx-auto flex items-center justify-between px-4 py-4 bg-surface rounded-xl mb-6 shadow">
    <div class="flex items-center space-x-3">
      <img src="/static/EVER green3.png" alt="Logo" class="h-10 w-10 rounded-full border border-highlight">
      <span class="text-xl font-bold text-highlight">å‘½ç†å·¥å…·</span>
    </div>

    <nav class="space-x-6 text-textlight text-base">
      <a href="/pricing" class="hover:text-highlight transition">è´­ä¹°</a>
      {% if session.get('user') %}
      <a href="/logout" class="hover:text-highlight transition">ç™»å‡º</a>
      {% else %}
      <a href="/login" class="hover:text-highlight transition">ç™»å½•</a>
      {% endif %}
    </nav>
  </header>

  <!-- â— Show Upgrade Banner if not PRO -->
  {% if not session.get('is_pro', False) %}
  <div class="bg-surface p-5 rounded-xl shadow text-yellow-400 mb-6">
    è¦æŸ¥çœ‹æ›´å¤šè¾…åŠ©åˆ†æï¼Ÿ<a href="/pricing" class="text-blue-400 underline">å‡çº§ä¸ºä¸“ä¸šç‰ˆ</a>ï¼
  </div>
  {% endif %}
  

  <h1 class="text-3xl font-bold text-textlight mb-6 text-center">âœ¨æ•°å­—èƒ½é‡åˆ†æâœ¨</h1>

  <!-- ğŸ“ Input Form -->
  <form method="POST" class="bg-surface p-6 rounded-xl shadow-lg space-y-4 mb-10">
    <label for="input_data" class="block text-lg text-textlight font-semibold">è¯·è¾“å…¥æ‚¨çš„è½¦ç‰Œã€ç”µè¯å·ç ã€æˆ–ä»»ä½•è‹±æ–‡ã€æ•°å­—ï¼š</label>
    <input type="text" id="input_data" name="input_data" required
           class="w-full px-4 py-2 rounded-md bg-dark border border-soft text-textlight focus:ring-2 focus:ring-highlight outline-none" />
    <button type="submit"
            class="w-full bg-highlight hover:bg-blue-700 text-white font-semibold py-2 rounded-md transition-all">
      åˆ†æ
    </button>
  </form>

  {% if input_data %}
  <div class="space-y-6">

    <!-- ğŸ“‹ ç”¨æˆ·è¾“å…¥ -->
    <div class="bg-surface p-5 rounded-xl shadow">
      <h2 class="text-xl font-bold text-highlight mb-2">ğŸ§¾ æ‚¨çš„è¾“å…¥å†…å®¹ï¼š</h2>
      <p class="text-textlight text-lg">{{ input_data }}</p>
    </div>

    <!-- ğŸ” ä¸»åˆ†æ -->
    <div class="bg-surface p-5 rounded-xl shadow">
      <h2 class="text-xl font-bold text-highlight mb-2">ğŸ” ç»„åˆèƒ½é‡åˆ†æï¼š</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left border border-gray-700 rounded overflow-hidden">
          <thead class="bg-gray-800 text-textlight">
            <tr>
              <th class="px-4 py-2 border-b border-gray-600">ç»„åˆç±»å‹</th>
              <th class="px-4 py-2 border-b border-gray-600">æ•°å­—ç»„åˆ</th>
              <th class="px-4 py-2 border-b border-gray-600">ç´¯è®¡èƒ½é‡</th>
            </tr>
          </thead>
          <tbody>
            {% for key, value in grouped_stats.items() %}
            <tr class="bg-surface hover:bg-gray-700">
              <td class="px-4 py-2 border-b border-gray-700">{{ key }}</td>
              <td class="px-4 py-2 border-b border-gray-700">{{ group_to_pairs[key] | join(', ') }}</td>
              <td class="px-4 py-2 border-b border-gray-700">{{ grouped_energy[key] if grouped_energy[key] else 0 }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ğŸ“ˆ åˆ†å¸ƒå›¾ -->
    <div class="bg-surface p-5 rounded-xl shadow">
      <h2 class="text-xl font-bold text-highlight mb-2">ğŸ“ˆ ç»„åˆç±»å‹åˆ†å¸ƒå›¾</h2>
      <canvas id="groupedBarChart" height="120"></canvas>
    </div>

    <script>
      const groupedStats = JSON.parse('{{ grouped_stats_json | tojson | safe }}');

      const labels = Object.keys(groupedStats);
      const data = Object.values(groupedStats).map(item => item.count);

      const colorMap = {
        'å¤©åŒ»': '#22c55e',
        'å»¶å¹´': '#0ea5e9',
        'ç”Ÿæ°”': '#fbbf24',
        'ä¼ä½': '#64748b',
        'ç»å‘½': '#ef4444',
        'ç¥¸å®³': '#f97316',
        'äº”é¬¼': '#a21caf',
        'å…­ç…': '#6366f1'
      };

      const backgroundColors = labels.map(lab => colorMap[lab] || '#a3a3a3');

      const ctx = document.getElementById('groupedBarChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'å‡ºç°æ¬¡æ•°',
            data: data,
            backgroundColor: backgroundColors,
            borderRadius: 8
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: '#334155' }},
            x: { ticks: { color: '#fff' }, grid: { display: false }}
          }
        }
      });
    </script>

    {% if ending_warning %}
    <div class="bg-surface p-5 rounded-xl shadow border border-red-500">
      <h2 class="text-xl font-bold text-red-400 mb-2">ğŸ’¸ ç ´è´¢è­¦ç¤º</h2>
      <p class="text-textlight text-base">{{ ending_warning }}</p>
    </div>
    {% endif %}

    <!-- ğŸ“š é«˜çº§åˆ†æï¼ˆä»…PROç”¨æˆ·ï¼‰ -->
    {% if is_pro %}
      {% if secondary_result %}
      <div class="bg-surface p-5 rounded-xl shadow">
        <h2 class="text-xl font-bold text-green-400 mb-2">ğŸ“˜ è¾…åŠ©ç»„åˆæç¤ºï¼š</h2>
        <ul class="list-disc pl-5 space-y-1">
          {% for result in secondary_result %}
            <li>{{ result }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if special_definitions %}
      <div class="bg-surface p-5 rounded-xl shadow">
        <h2 class="text-xl font-bold text-red-400 mb-2">ğŸš¨ ç‰¹æ®Šç»„åˆæé†’ï¼š</h2>
        <ul class="list-disc pl-5 space-y-1">
          {% for result in special_definitions %}
            <li>{{ result }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    {% endif %}

  </div>
  {% endif %}

</div>

</body>
</html>
